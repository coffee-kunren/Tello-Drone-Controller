# Tello Drone Controller

## 目次
- [概要](#概要)
- [使用技術](#使用技術)
- [必要ライブラリ](#必要ライブラリ)
- [機能詳細](#機能詳細)
- [実行の流れ](#実行の流れ)
- [環境構築時の補足](#環境構築時の補足)

## 概要
DJI Telloを用いたリアルタイム画像認識対応ドローン制御プログラム。  
キーボード操作、録画・写真撮影、ピースサイン自動撮影、前方衝突防止、人間追従（回転）機能を実装。

## 使用技術
- Python 3.10.11
- tellopy
- pygame
- OpenCV
- numpy
- mediapipe
- ultralytics (YOLOv8)

## 必要ライブラリ
```bash
pip install -r requirements.txt
```
*※Windows環境では「av」ライブラリ使用のため、追加でネットから
 「ffmpeg-n8.0-latest-win64-lgpl-shared-8.0」 をダウンロードし
  プロジェクトフォルダに配置すること。*

## 機能詳細
- **キーボードでのドローン操作**  
  キー入力でドローンの操縦やカメラ機能が使用可能。
  対応キーは以下の通り：

  | キー          | 機能                    |
  |---------------|-------------------------|
  | W / A / S / D | 移動（前後左右）        |
  | ↑ / ↓       | 上昇 / 下降             |
  | ← / →       | 回転（左右）            |
  | Tab           | 離陸                    |
  | Backspace     | 着陸                    |
  | R             | 録画（開始 / 停止）     |
  | Enter         | 写真撮影                |
  | C             | 人間追従（ON / OFF）    |

- **内蔵カメラで録画や写真撮影**  
  - 対応するキーを押すと写真や録画が保存可能。  
     撮影時は画面上中央に「Photo Saved.」が、
     録画中は画面右上に「*REC」が表示される。

  - 記録したデータはプロジェクト内「recording」フォルダに、
     「yyyyMMdd_hhmmss/tello_yyyyMMdd_hhmmss.jpg(.mp4)」として保存。  
     **※recordingフォルダは実行時に自動で作成。**  
     ※ファイル名は記録した時の日時。

  - カメラ起動中、ピースサインを画面内に3秒以上継続すると
    「3，2，1」の後に写真を撮影。  
    ※手の検出はカメラの画角に入った順に認識する仕様上、
      大人数の場合は後から映った手が判定対象外になる可能性あり。

- **前方衝突防止センサー / 人間追従**  
  - カメラで認識した対象(人間)を四角で囲んで表示。  
    画面左下には、その中で最も近い(四角の大きい)対象との
    距離を基準として、ドローンの状態を、  
      "SAFE"(遠い)  →  "SLOW"  →  "STOP"(近い)  
    の３つにパターン分けしている。

  - 衝突防止センサーは前進("W"キー)入力に対して、以下の制限がかかる：  
      "SAFE"：制限なし  
      "SLOW"：前進速度を制限(落とす)  
      "STOP"：前進禁止(スピード０)  
    ※なお、このセンサーは常時作用している。

  - 人間追従はモードON時("C"キー)は画面に十字線が表示され、  
    最も近い対象に対して、対象が画面中央にくるようドローンが
    その場で回転(時計/半時計周り)する。  
    ※センサーの都合上、前後左右に動く機能は未実装。

## 実行の流れ
1. ドローンとPCをWi-Fi接続
2. pyファイルを実行
3. 「Tello Controls」と「Tello Camera」の2つのウィンドウが表示
4. 「操作ウィンドウ」をクリックしてフォーカス**(※注意)**
5. ドローン操作
6. プログラム終了時：
   - 「画面」をフォーカスして "Q" キー
   - またはコンソールで Ctrl+C

## 環境構築時の補足
- できればPythonのバージョンは「3.10.11」を使用してください。  
  (3.10.11以降でも正常に動かないバージョンがあるため)
- ライブラリの読込みでエラーになる場合、「Visual C++ ランタイム」が入っていない可能性があります。  
  →**「Microsoft Visual C++ 再頒布可能パッケージ」をインストールしてください**
- プロジェクトを置くディレクトリのパスに日本語が含まれているとうまくいかない可能性があります。  
  →**パスに日本語を含まないようにするか仮想環境での実行をおすすめします**
- PC側の権限関係で保存フォルダ(recordings)が作れなかったり撮影データの保存ができなかったりします。  
  →**コマンドプロンプトやPowerShell、それらの管理者権限での実行などを試してみてください**
- 録画した映像のスピードが早かったり遅かったりする可能性があります。  
  →**「main.py」上部の定数「VIDEO_FPS」を変更して調整してください  
    ※調整方法
    - 動画が遅い→「VIDEO_FPS」の値を上げる
    - 動画が早い→「VIDEO_FPS」の値を下げる**
